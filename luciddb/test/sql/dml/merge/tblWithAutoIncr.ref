0: jdbc:luciddb:> set schema 'mergetest';
0: jdbc:luciddb:> 
0: jdbc:luciddb:> -- Create and populate tables with auto increment columns
0: jdbc:luciddb:> 
0: jdbc:luciddb:> create table EMPSEQ (
. . . . . . . . >   INCCOL bigint generated by default as identity
. . . . . . . . >     (maxvalue 209 start with 100) not null,
. . . . . . . . >   EMPNO integer not null,
. . . . . . . . >   FNAME varchar(15),
. . . . . . . . >   LNAME varchar(15),
. . . . . . . . >   SEX char(1),
. . . . . . . . >   DEPTNO integer,
. . . . . . . . >   MANAGER integer,
. . . . . . . . >   LOCID char(2),
. . . . . . . . >   CITY varchar(8),
. . . . . . . . >   SAL decimal(10, 2),
. . . . . . . . >   COMMISION decimal(10, 2),
. . . . . . . . >   HOBBY varchar(25)
. . . . . . . . > );
0: jdbc:luciddb:> 
0: jdbc:luciddb:> create table EMPSEQ2 (
. . . . . . . . >   INCCOL bigint generated by default as identity
. . . . . . . . >     (maxvalue 209 start with 100) not null,
. . . . . . . . >   EMPNO integer not null,
. . . . . . . . >   FNAME varchar(15),
. . . . . . . . >   LNAME varchar(15),
. . . . . . . . >   SEX char(1),
. . . . . . . . >   DEPTNO integer,
. . . . . . . . >   MANAGER integer,
. . . . . . . . >   LOCID char(2),
. . . . . . . . >   CITY varchar(8),
. . . . . . . . >   SAL decimal(10, 2),
. . . . . . . . >   COMMISION decimal(10, 2),
. . . . . . . . >   HOBBY varchar(25)
. . . . . . . . > );
0: jdbc:luciddb:> 
0: jdbc:luciddb:> 
0: jdbc:luciddb:> create table LOCATIONSEQ (
. . . . . . . . >   INCCOL integer generated always as identity
. . . . . . . . >     (start with 0 maxvalue 150 increment by 10 ),
. . . . . . . . >   LOCID char(2) not null,
. . . . . . . . >   STREET varchar(30),
. . . . . . . . >   CITY varchar(20),
. . . . . . . . >   STATE char(2),
. . . . . . . . >   ZIP decimal(5,0)
. . . . . . . . > );
0: jdbc:luciddb:> 
0: jdbc:luciddb:> 
0: jdbc:luciddb:> insert into EMPSEQ(EMPNO, FNAME, LNAME, SEX, DEPTNO, MANAGER, LOCID, SAL, 
. . . . . . . . >   COMMISION, HOBBY) 
. . . . . . . . > select * from EMP;
0: jdbc:luciddb:> 
0: jdbc:luciddb:> insert into LOCATIONSEQ(LOCID, STREET, CITY, STATE, ZIP)
. . . . . . . . > select * from LOCATION;
0: jdbc:luciddb:> 
0: jdbc:luciddb:> insert into LOCATIONSEQ(LOCID, STREET, CITY, STATE, ZIP)
. . . . . . . . > values ('PP', '100 Sesame Street', 'Portside', 'PA', 24912),
. . . . . . . . >   ('IL', '111 Technology Way', null, 'IL', 60563);
0: jdbc:luciddb:> 
0: jdbc:luciddb:> 
0: jdbc:luciddb:> select * from EMPSEQ order by INCCOL;
+---------+--------+--------+-----------+------+---------+----------+--------+-------+-----------+------------+----------------+
| INCCOL  | EMPNO  | FNAME  |   LNAME   | SEX  | DEPTNO  | MANAGER  | LOCID  | CITY  |    SAL    | COMMISION  |     HOBBY      |
+---------+--------+--------+-----------+------+---------+----------+--------+-------+-----------+------------+----------------+
| 100     | 100    | Bill   | Bush      | M    | 30      |          | HQ     |       | 50000.00  |            | Piano          |
| 101     | 101    | Bob    | Brown     | M    | 50      | 100      | SJ     |       | 50000.00  |            | Skiing         |
| 102     | 102    | Julie  | Andrews   | F    | 30      | 104      | MP     |       | 50000.00  |            | Rugby          |
| 103     | 103    | Frank  | Webber    | M    | 20      | 102      | MP     |       | 50000.00  |            | Piano          |
| 104     | 104    | Fritz  | Fratz     | M    | 10      | 100      | HQ     |       | 50000.00  |            | Rugby          |
| 105     | 105    | Rich   | Guy       | M    | 30      | 102      | HQ     |       | 50000.00  |            | Gambling       |
| 106     | 106    | Rob    | Roy       | M    | 40      | 102      | SF     |       | 50000.00  | 7.00       | Karate         |
| 107     | 107    | Robin  | Williams  | M    | 40      | 103      | HQ     |       | 50000.00  | 10.00      | Telling Jokes  |
| 108     | 108    | Mary   | Reynolds  | F    | 50      | 104      | SF     |       | 50000.00  |            |                |
| 109     | 109    | Jack   | Nife      | M    | 40      | 100      | SF     |       | 50000.00  | 5.00       |                |
| 110     | 110    | Jill   | Jones     | F    | 30      | 101      | MP     |       | 50000.00  |            |                |
+---------+--------+--------+-----------+------+---------+----------+--------+-------+-----------+------------+----------------+
0: jdbc:luciddb:> select * from LOCATIONSEQ order by INCCOL;
+---------+--------+---------------------------+----------------+--------+--------+
| INCCOL  | LOCID  |          STREET           |      CITY      | STATE  |  ZIP   |
+---------+--------+---------------------------+----------------+--------+--------+
| 0       | HQ     | 1730 South Amphlett Blvd  | San Mateo      | CA     | 94042  |
| 10      | SF     | 100 Market                | San Francisco  | CA     | 94987  |
| 20      | MP     | 770 Coleman               | Menlo Park     | CA     | 94025  |
| 30      | SJ     | Main Street               | Los Angeles    | CA     | 92123  |
| 40      | PP     | 100 Sesame Street         | Portside       | PA     | 24912  |
| 50      | IL     | 111 Technology Way        |                | IL     | 60563  |
+---------+--------+---------------------------+----------------+--------+--------+
0: jdbc:luciddb:> 
0: jdbc:luciddb:> 
0: jdbc:luciddb:> -- basic merge into table with auto increment column
0: jdbc:luciddb:> merge into empseq e
. . . . . . . . >   using locationseq l on e.locid = l.locid
. . . . . . . . >   when matched then
. . . . . . . . >     update set sal = case when l.city = 'San Francisco' then e.sal + 25000
. . . . . . . . >                      when l.city = 'Los Angeles' then e.sal + 111 
. . . . . . . . >                      else e.sal end,
. . . . . . . . >                city = l.city,
. . . . . . . . >                hobby = 'Hanging out on ' || substring(l.street, 5)
. . . . . . . . >   when not matched then
. . . . . . . . >     insert (empno, fname, lname)
. . . . . . . . >     values (l.zip, 'empA' || substring(l.street, 4, 8), cast (l.zip as varchar(15)));
0: jdbc:luciddb:> 
0: jdbc:luciddb:> select * from empseq order by inccol;
+---------+--------+---------------+-----------+------+---------+----------+--------+-----------+-----------+------------+----------------------------+
| INCCOL  | EMPNO  |     FNAME     |   LNAME   | SEX  | DEPTNO  | MANAGER  | LOCID  |   CITY    |    SAL    | COMMISION  |           HOBBY            |
+---------+--------+---------------+-----------+------+---------+----------+--------+-----------+-----------+------------+----------------------------+
| 100     | 100    | Bill          | Bush      | M    | 30      |          | HQ     | San Mate  | 50000.00  |            | Hanging out on  South Amp  |
| 101     | 101    | Bob           | Brown     | M    | 50      | 100      | SJ     | Los Ange  | 50111.00  |            | Hanging out on  Street     |
| 102     | 102    | Julie         | Andrews   | F    | 30      | 104      | MP     | Menlo Pa  | 50000.00  |            | Hanging out on Coleman     |
| 103     | 103    | Frank         | Webber    | M    | 20      | 102      | MP     | Menlo Pa  | 50000.00  |            | Hanging out on Coleman     |
| 104     | 104    | Fritz         | Fratz     | M    | 10      | 100      | HQ     | San Mate  | 50000.00  |            | Hanging out on  South Amp  |
| 105     | 105    | Rich          | Guy       | M    | 30      | 102      | HQ     | San Mate  | 50000.00  |            | Hanging out on  South Amp  |
| 106     | 106    | Rob           | Roy       | M    | 40      | 102      | SF     | San Fran  | 75000.00  | 7.00       | Hanging out on Market      |
| 107     | 107    | Robin         | Williams  | M    | 40      | 103      | HQ     | San Mate  | 50000.00  | 10.00      | Hanging out on  South Amp  |
| 108     | 108    | Mary          | Reynolds  | F    | 50      | 104      | SF     | San Fran  | 75000.00  |            | Hanging out on Market      |
| 109     | 109    | Jack          | Nife      | M    | 40      | 100      | SF     | San Fran  | 75000.00  | 5.00       | Hanging out on Market      |
| 110     | 110    | Jill          | Jones     | F    | 30      | 101      | MP     | Menlo Pa  | 50000.00  |            | Hanging out on Coleman     |
| 111     | 24912  | empA Sesame   | 24912     |      |         |          |        |           |           |            |                            |
| 112     | 60563  | empA Technol  | 60563     |      |         |          |        |           |           |            |                            |
+---------+--------+---------------+-----------+------+---------+----------+--------+-----------+-----------+------------+----------------------------+
0: jdbc:luciddb:> 
0: jdbc:luciddb:> 
0: jdbc:luciddb:> -- merge into table with auto inc column (forcing values to auto inc)
0: jdbc:luciddb:> delete from empseq;
0: jdbc:luciddb:> insert into EMPSEQ(EMPNO, FNAME, LNAME, SEX, DEPTNO, MANAGER, LOCID, SAL, 
. . . . . . . . >   COMMISION, HOBBY) 
. . . . . . . . > select * from EMP;
0: jdbc:luciddb:> merge into empseq e
. . . . . . . . >   using locationseq l on e.locid = l.locid
. . . . . . . . >   when matched then
. . . . . . . . >     update set sal = case when l.city = 'San Francisco' then e.sal + 25000
. . . . . . . . >                      when l.city = 'Los Angeles' then e.sal + 111 
. . . . . . . . >                      else e.sal end,
. . . . . . . . >                city = l.city,
. . . . . . . . >                hobby = 'Hanging out on ' || substring(l.street, 5)
. . . . . . . . >   when not matched then
. . . . . . . . >     insert (inccol, empno, fname, lname)
. . . . . . . . >     values (999, l.zip, 'empA' || substring(l.street, 4, 8), cast (l.zip as varchar(15)));
0: jdbc:luciddb:> 
0: jdbc:luciddb:> select * from empseq order by inccol;
+---------+--------+---------------+-----------+------+---------+----------+--------+-----------+-----------+------------+----------------------------+
| INCCOL  | EMPNO  |     FNAME     |   LNAME   | SEX  | DEPTNO  | MANAGER  | LOCID  |   CITY    |    SAL    | COMMISION  |           HOBBY            |
+---------+--------+---------------+-----------+------+---------+----------+--------+-----------+-----------+------------+----------------------------+
| 113     | 100    | Bill          | Bush      | M    | 30      |          | HQ     | San Mate  | 50000.00  |            | Hanging out on  South Amp  |
| 114     | 101    | Bob           | Brown     | M    | 50      | 100      | SJ     | Los Ange  | 50111.00  |            | Hanging out on  Street     |
| 115     | 102    | Julie         | Andrews   | F    | 30      | 104      | MP     | Menlo Pa  | 50000.00  |            | Hanging out on Coleman     |
| 116     | 103    | Frank         | Webber    | M    | 20      | 102      | MP     | Menlo Pa  | 50000.00  |            | Hanging out on Coleman     |
| 117     | 104    | Fritz         | Fratz     | M    | 10      | 100      | HQ     | San Mate  | 50000.00  |            | Hanging out on  South Amp  |
| 118     | 105    | Rich          | Guy       | M    | 30      | 102      | HQ     | San Mate  | 50000.00  |            | Hanging out on  South Amp  |
| 119     | 106    | Rob           | Roy       | M    | 40      | 102      | SF     | San Fran  | 75000.00  | 7.00       | Hanging out on Market      |
| 120     | 107    | Robin         | Williams  | M    | 40      | 103      | HQ     | San Mate  | 50000.00  | 10.00      | Hanging out on  South Amp  |
| 121     | 108    | Mary          | Reynolds  | F    | 50      | 104      | SF     | San Fran  | 75000.00  |            | Hanging out on Market      |
| 122     | 109    | Jack          | Nife      | M    | 40      | 100      | SF     | San Fran  | 75000.00  | 5.00       | Hanging out on Market      |
| 123     | 110    | Jill          | Jones     | F    | 30      | 101      | MP     | Menlo Pa  | 50000.00  |            | Hanging out on Coleman     |
| 999     | 24912  | empA Sesame   | 24912     |      |         |          |        |           |           |            |                            |
| 999     | 60563  | empA Technol  | 60563     |      |         |          |        |           |           |            |                            |
+---------+--------+---------------+-----------+------+---------+----------+--------+-----------+-----------+------------+----------------------------+
0: jdbc:luciddb:> 
0: jdbc:luciddb:> 
0: jdbc:luciddb:> -- basic merge from table with auto increment column
0: jdbc:luciddb:> delete from empseq;
0: jdbc:luciddb:> insert into EMPSEQ(EMPNO, FNAME, LNAME, SEX, DEPTNO, MANAGER, LOCID, SAL, 
. . . . . . . . >   COMMISION, HOBBY) 
. . . . . . . . > select * from EMP;
0: jdbc:luciddb:> merge into empseq2 as e2 
. . . . . . . . >   using empseq as e
. . . . . . . . >     on e.empno = e2.empno
. . . . . . . . >   when matched then
. . . . . . . . >     update set inccol = 0
. . . . . . . . >   when not matched then
. . . . . . . . >     insert (empno, fname, lname)
. . . . . . . . >     values (e.empno, e.fname, e.lname);
0: jdbc:luciddb:> 
0: jdbc:luciddb:> select * from empseq2 order by inccol;
+---------+--------+--------+-----------+------+---------+----------+--------+-------+------+------------+--------+
| INCCOL  | EMPNO  | FNAME  |   LNAME   | SEX  | DEPTNO  | MANAGER  | LOCID  | CITY  | SAL  | COMMISION  | HOBBY  |
+---------+--------+--------+-----------+------+---------+----------+--------+-------+------+------------+--------+
| 100     | 100    | Bill   | Bush      |      |         |          |        |       |      |            |        |
| 101     | 101    | Bob    | Brown     |      |         |          |        |       |      |            |        |
| 102     | 102    | Julie  | Andrews   |      |         |          |        |       |      |            |        |
| 103     | 103    | Frank  | Webber    |      |         |          |        |       |      |            |        |
| 104     | 104    | Fritz  | Fratz     |      |         |          |        |       |      |            |        |
| 105     | 105    | Rich   | Guy       |      |         |          |        |       |      |            |        |
| 106     | 106    | Rob    | Roy       |      |         |          |        |       |      |            |        |
| 107     | 107    | Robin  | Williams  |      |         |          |        |       |      |            |        |
| 108     | 108    | Mary   | Reynolds  |      |         |          |        |       |      |            |        |
| 109     | 109    | Jack   | Nife      |      |         |          |        |       |      |            |        |
| 110     | 110    | Jill   | Jones     |      |         |          |        |       |      |            |        |
+---------+--------+--------+-----------+------+---------+----------+--------+-------+------+------------+--------+
0: jdbc:luciddb:> delete from empseq2;
0: jdbc:luciddb:> 
0: jdbc:luciddb:> 
0: jdbc:luciddb:> --
0: jdbc:luciddb:> -- test of merge out of range
0: jdbc:luciddb:> --
0: jdbc:luciddb:> -- merge out of range -> error
0: jdbc:luciddb:> create table t1(n1 integer);
0: jdbc:luciddb:> insert into t1 values (1),(2),(3);
0: jdbc:luciddb:> create table t2 (m1 integer generated by default as identity
. . . . . . . . >                     (maxvalue 2 start with 1),
. . . . . . . . >                  m2 integer);
0: jdbc:luciddb:> merge into t2 
. . . . . . . . > using t1 on n1=m2
. . . . . . . . > when matched then
. . . . . . . . >   update set m2=0
. . . . . . . . > when not matched then
. . . . . . . . >   insert (m2) values (n1);
Error: Sequence generator limit exceeded for LOCALDB.MERGETEST.T2 (state=,code=0)
0: jdbc:luciddb:> 
0: jdbc:luciddb:> drop table t1;
0: jdbc:luciddb:> drop table t2; 
0: jdbc:luciddb:> 
0: jdbc:luciddb:> 
0: jdbc:luciddb:> -- merge out of range -> force, no error
0: jdbc:luciddb:> create table t1(n1 integer);
0: jdbc:luciddb:> insert into t1 values (1),(2),(3);
0: jdbc:luciddb:> create table t2 (m1 integer generated by default as identity
. . . . . . . . >                     (maxvalue 2 start with 1),
. . . . . . . . >                  m2 integer);
0: jdbc:luciddb:> merge into t2 
. . . . . . . . > using t1 on n1=m2
. . . . . . . . > when matched then
. . . . . . . . >   update set m2=0
. . . . . . . . > when not matched then
. . . . . . . . >   insert (m1,m2) values (999,n1);
0: jdbc:luciddb:> 
0: jdbc:luciddb:> select * from t2;
+------+-----+
|  M1  | M2  |
+------+-----+
| 999  | 1   |
| 999  | 2   |
| 999  | 3   |
+------+-----+
0: jdbc:luciddb:> 
0: jdbc:luciddb:> -- still no error
0: jdbc:luciddb:> insert into t1 values (4),(5);
0: jdbc:luciddb:> merge into t2
. . . . . . . . > using t1 on n1=m2
. . . . . . . . > when matched then
. . . . . . . . >   update set m2=0
. . . . . . . . > when not matched then
. . . . . . . . >   insert (m2) values (n1);
0: jdbc:luciddb:> 
0: jdbc:luciddb:> select * from t2;
+------+-----+
|  M1  | M2  |
+------+-----+
| 999  | 0   |
| 999  | 0   |
| 999  | 0   |
| 1    | 4   |
| 2    | 5   |
+------+-----+
0: jdbc:luciddb:> 
0: jdbc:luciddb:> -- error, out of range
0: jdbc:luciddb:> insert into t1 values (6);
0: jdbc:luciddb:> merge into t2
. . . . . . . . > using t1 on n1=m2
. . . . . . . . > when matched then
. . . . . . . . >   update set m2=-1
. . . . . . . . > when not matched then
. . . . . . . . >   insert (m2) values (n1);
Error: Sequence generator limit exceeded for LOCALDB.MERGETEST.T2 (state=,code=0)
0: jdbc:luciddb:> 
0: jdbc:luciddb:> 
0: jdbc:luciddb:> drop table t1;
0: jdbc:luciddb:> drop table t2; 
0: jdbc:luciddb:> 
0: jdbc:luciddb:> 
0: jdbc:luciddb:> -- change the default current value for empseq.inccol
0: jdbc:luciddb:> insert into EMPSEQ(INCCOL, EMPNO, FNAME, LNAME, SEX, DEPTNO, MANAGER, LOCID, 
. . . . . . . . >   SAL)
. . . . . . . . > values (150, 150, 'Lola', null, 'F', null, 100, null, 0),
. . . . . . . . >   (160, 160, 'Pete', 'McIntyre', 'M', null, null, 'PP', null);
0: jdbc:luciddb:> 
0: jdbc:luciddb:> select * from empseq order by inccol;
+---------+--------+--------+-----------+------+---------+----------+--------+-------+-----------+------------+----------------+
| INCCOL  | EMPNO  | FNAME  |   LNAME   | SEX  | DEPTNO  | MANAGER  | LOCID  | CITY  |    SAL    | COMMISION  |     HOBBY      |
+---------+--------+--------+-----------+------+---------+----------+--------+-------+-----------+------------+----------------+
| 124     | 100    | Bill   | Bush      | M    | 30      |          | HQ     |       | 50000.00  |            | Piano          |
| 125     | 101    | Bob    | Brown     | M    | 50      | 100      | SJ     |       | 50000.00  |            | Skiing         |
| 126     | 102    | Julie  | Andrews   | F    | 30      | 104      | MP     |       | 50000.00  |            | Rugby          |
| 127     | 103    | Frank  | Webber    | M    | 20      | 102      | MP     |       | 50000.00  |            | Piano          |
| 128     | 104    | Fritz  | Fratz     | M    | 10      | 100      | HQ     |       | 50000.00  |            | Rugby          |
| 129     | 105    | Rich   | Guy       | M    | 30      | 102      | HQ     |       | 50000.00  |            | Gambling       |
| 130     | 106    | Rob    | Roy       | M    | 40      | 102      | SF     |       | 50000.00  | 7.00       | Karate         |
| 131     | 107    | Robin  | Williams  | M    | 40      | 103      | HQ     |       | 50000.00  | 10.00      | Telling Jokes  |
| 132     | 108    | Mary   | Reynolds  | F    | 50      | 104      | SF     |       | 50000.00  |            |                |
| 133     | 109    | Jack   | Nife      | M    | 40      | 100      | SF     |       | 50000.00  | 5.00       |                |
| 134     | 110    | Jill   | Jones     | F    | 30      | 101      | MP     |       | 50000.00  |            |                |
| 150     | 150    | Lola   |           | F    |         | 100      |        |       | 0.00      |            |                |
| 160     | 160    | Pete   | McIntyre  | M    |         |          | PP     |       |           |            |                |
+---------+--------+--------+-----------+------+---------+----------+--------+-------+-----------+------------+----------------+
0: jdbc:luciddb:> 
0: jdbc:luciddb:> 
0: jdbc:luciddb:> 
0: jdbc:luciddb:> -- clean up
0: jdbc:luciddb:> drop table empseq;
0: jdbc:luciddb:> drop table empseq2;
0: jdbc:luciddb:> drop table locationseq;
0: jdbc:luciddb:> 
0: jdbc:luciddb:> !quit
