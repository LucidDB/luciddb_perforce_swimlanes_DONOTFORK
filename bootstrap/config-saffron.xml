<!-- begin -->
    <!-- some of the properties are set in config-<hostname>.xml -->

    <property name="artifacts.dir" value="${artifacts.root}/${project}"/>
    <property name="logs.dir" value="${red.bootstrap.dir}/logs" />

    <labelincrementer 
        port="${p4port}" 
        client="${p4client}" 
        user="${p4user}" 
        view="${p4root}/..." 
    />

	<!-- Bootstrappers are run with every build before mod checks -->
	<bootstrappers>
        <p4bootstrapper port="${p4port}" client="${p4client}" user="${p4user}" view="${p4root}/bootstrap/..."/>
	</bootstrappers>

    <listeners>
        <currentbuildstatuslistener file="${logs.dir}/${project}/currentbuildstatus.txt"/>
    </listeners>

	<!-- Defines where cruise looks for changes, to decide whether to run the build -->
	<modificationset quietperiod="300">
        <p4 port="${p4port}" client="${p4client}" user="${p4user}" view="${p4root}/fennel/..."/>
        <p4 port="${p4port}" client="${p4client}" user="${p4user}" view="${p4root}/farrago/..."/>
        <p4 port="${p4port}" client="${p4client}" user="${p4user}" view="${p4root}/saffron/..."/>
        <p4 port="${p4port}" client="${p4client}" user="${p4user}" view="${p4root}/thirdparty/..."/>
	</modificationset>

	<!-- Configures the actual build loop, how often and which build file/target -->
    <schedule interval="${build.interval}">
        <ant buildfile="${bootstrap.dir}/build-saffron.xml"  antworkingdir="${bootstrap.dir}" uselogger="true" usedebug="false" antscript="${ant}" target="integration-build-and-test">
            <property name="p4.port" value="${p4port}"/>
            <property name="p4.user" value="${p4user}"/>
            <property name="p4.client" value="${p4client}"/>

            <property name="default.build.home" value="${open.default.build.home}"/>
            <property name="integration.build.home" value="${open.integration.build.home}"/>
            <property name="open.build.home" value="${open.integration.build.home}"/>

            <property name="open_root" value="${p4root}"/>
		</ant>
	</schedule>

	<!-- directory to write build logs to -->
    <log dir="${logs.dir}/${project}">
        <merge dir="${open.integration.build.home}/saffron/testlog"/>
	</log>

	<!-- Publishers are run *after* a build completes -->
	<publishers>
        <onsuccess>
            <antpublisher 
                antscript="${ant}"
                antworkingdir="${red.bootstrap.dir}"
                buildfile="set-p4-counter.xml"
                uselogger="true"
                usedebug="true"
                target="set.p4.counter">

                <property name="p4.port" value="${p4port}"/>
                <property name="p4.user" value="${p4user}"/>
                <property name="p4.client" value="${p4client}"/>

                <property name="p4.counter.name" value="${p4.counter.name}"/>
            </antpublisher>
        </onsuccess>

        <artifactspublisher 
            dir="${open.integration.build.home}/saffron/trace" 
            dest="${artifacts.dir}" 
            subdirectory="trace"/>

        <artifactspublisher 
            dir="${open.integration.build.home}/saffron/testlog" 
            dest="${artifacts.dir}" 
            subdirectory="testlog"/>

        <email 
            buildresultsurl="${buildresultsurl}/${project}"
            mailhost="${mailhost}"
            reportsuccess="${reportsuccess}"
            returnname="${returnname}"
            returnaddress="${returnaddress}"
            skipusers="${skipusers}"
            spamwhilebroken="${spamwhilebroken}"
            subjectprefix="${subjectprefix}">

            <failure address="${failureaddress}" reportWhenFixed="${reportwhenfixed}"/>
            <propertiesmapper file="${emailmapper}"/>
            <always address="${alwaysaddress}"/>
	    </email>

	</publishers>

    <plugin name="labelincrementer"
        classname="net.sourceforge.cruisecontrol.labelincrementers.P4ChangelistLabelIncrementer"/>

<!-- the end -->

