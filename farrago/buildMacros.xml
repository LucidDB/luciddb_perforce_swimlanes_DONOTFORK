<?xml version="1.0" encoding="UTF-8"?>
<!-- $Id$ -->
<!-- Farrago build macro definitions -->

<!-- These XML ENTITY "macros" help avoid redundancy in property -->
<!-- settings. They can be used with <jvmarg> or <arg> as the line -->
<!-- attribute. -->
<!DOCTYPE project [

<!ENTITY FarragoProps
"
-Dnet.sf.farrago.home=${farrago.dir}
-Djava.util.logging.config.file=${FarragoTrace.properties}
">

]>

<project name="farragoBuildMacros" default="unspecified">

  <!-- classpath for running from iSQL -->
  <path id="isql.classpath">
    <pathelement location="${isql.dir}/isql-core.jar"/>
    <pathelement location="${isql.dir}/xerces.jar"/>
    <pathelement location="${isql.dir}/base64codec.jar"/>
    <pathelement location="${isql.dir}/bsf.jar"/>
    <pathelement location="${isql.dir}/jpython1.1.jar"/>
  </path>
  <property name="isql.classpath" refid="isql.classpath"/>

  <!-- NOTE: there used to be an ant bug preventing the use of mixed case names
  for macro elements -->

  <!-- Macro for forking ant -->
  <macrodef name="antFork">
    <attribute name="target" default="unspecifiedTarget"/>
    <attribute name="classpathref" default="ant.classpath"/>
    <element name="jvmargs" optional="yes"/>
    <sequential>
      <java classname="org.apache.tools.ant.Main" fork="true" failonerror="true"
        classpathref="@{classpathref}">
        <jvmargs/>
        <arg value="@{target}"/>
      </java>
    </sequential>
  </macrodef>

  <!-- Macro for forking ant to run an MDR task -->
  <macrodef name="mdrFork">
    <attribute name="target" default="unspecifiedTarget"/>
    <sequential>
      <loadproperties srcFile="${ReposStorage.properties}"/>
      <antFork target="@{target}">
        <jvmargs>
          <sysproperty key="org.netbeans.mdr.Logger" value="256"/>
          <syspropertyset>
            <propertyref prefix="org.netbeans.mdr"/>
            <propertyref prefix="MDRStorageProperty"/>
          </syspropertyset>
        </jvmargs>
      </antFork>
    </sequential>
  </macrodef>

  <!-- Customization for javac task -->
  <presetdef name="javaCompile">
    <javac debug="on" deprecation="on" source="1.4"/>
  </presetdef>

  <!-- Customization for java task -->
  <presetdef name="javaExec">
    <java fork="yes" failonerror="true">
      <jvmarg line="${assertions.jvmarg}"/>
      <jvmarg line="&FarragoProps;"/>
    </java>
  </presetdef>

  <!-- Macro for running JSwat -->
  <macrodef name="jswatDebug">
    <attribute name="classpath" default="unspecified"/>
    <attribute name="sourcepath" default="unspecified"/>
    <attribute name="classname" default="unspecified"/>
    <element name="jvmargs" optional="yes"/>
    <element name="programargs" optional="yes"/>
    <sequential>
      <java
        jar="${jswat.dir}/jswat.jar"
        fork="yes">
        <sysproperty key="java.ext.dirs" value="${java.home}/../lib"/>
        <arg value="classpath"/>
        <arg value="'@{classpath}'"/>
        <arg value=";"/>
        <arg value="sourcepath"/>
        <arg value="'@{sourcepath}'"/>
        <arg value=";"/>
        <arg value="options"/>
        <arg value="stopOnMain"/>
        <arg value="true"/>
        <arg value=";"/>
        <arg value="run"/>
        <arg line="${assertions.jvmarg}"/>
        <jvmargs/>
        <arg value="@{classname}"/>
        <programargs/>
      </java>
    </sequential>
  </macrodef>
 
  <!-- Macro for tranforming model -->
  <macrodef name="transformModel">
    <attribute name="inputfilename" default="unspecified"/>
    <attribute name="outputfilename" default="unspecified"/>
    <sequential>
	   <xslt style="${xmi.dir}/transformFEM.xsl"
		  in="@{inputfilename}"
		  out="@{outputfilename}" />
	   <replace file="@{outputfilename}"
		  token="org.omg.xmi.namespace.Model" value="omg.org/mof.Model/1.3" />
    </sequential>
  </macrodef>

  <macrodef name="uml2mof">
    <attribute name="umlmodelname" default="unspecified" />
    <attribute name="outputfilename" default="unspecified" />
	<attribute name="umlsansdiagrams" default="unspecified" />
    <sequential>
      <xslt style="${xmi.dir}/deleteUmlDiagrams.xsl"
        in="@{umlmodelname}"
        out="@{umlsansdiagrams}">
      </xslt>
      <java classname="org.netbeans.lib.jmi.uml2mof.Main" 
        fork="true" failonerror="true">
        <sysproperty key="org.netbeans.mdr.Logger" value="256"/>
        <classpath>
          <pathelement location="${mdrlibs.dir}/openide-util.jar"/>
          <!-- TODO jvs 12-Feb-2004:  get rid of openide-lookup.jar -->
          <pathelement location="${mdrlibs.dir}/openide-lookup.jar"/>
          <pathelement location="${mdrlibs.dir}/uml-1.4.jar"/>
          <pathelement location="${mdrlibs.dir}/uml2mof.jar"/>
        </classpath>
        <arg value="@{umlsansdiagrams}"/>
        <arg value="@{outputfilename}"/>
      </java>
      <delete>
        <fileset dir="." includes="mdr.bt*"/>
      </delete>
    </sequential>
  </macrodef>

  <macrodef name="iSQL">
    <attribute name="classpath" default="unspecified"/>
    <attribute name="propertieshome" default="unspecified"/>
    <sequential>
      <javaExec
        classname="org.isqlviewer.core.Launcher"
        classpathref="@{classpath}">
        <sysproperty key="isql.home" value="@{propertieshome}" />
      </javaExec>
    </sequential>
  </macrodef>

  <macrodef name="generateParser">
    <attribute name="combined" default="unspecified"/>
    <element name="components"/>
    <sequential>
      <delete file="@{combined}" quiet="true"/>
      <concat destfile="@{combined}" append="false">
        <components/>
      </concat>
      <chmod file="@{combined}" perm="a-w"/>
      <javacc 
        target="@{combined}" javacchome="${javacc.dir}"/>
    </sequential>
  </macrodef>

  <!-- Macro for running JUnit and sqlline tests -->
  <macrodef name="runTests">
    <element name="testfileset" optional="no"/>
    <element name="junitargs" optional="no"/>
    <sequential>
      <mkdir dir="${testlog.dir}"/>
      <junit printsummary="yes" fork="no" failureproperty="junit.failure"
        tempdir="${testlog.dir}" reloading="false">
        <sysproperty key="java.ext.dirs" value="${sqlline.dir}"/>
        <junitargs/>
        <formatter type="plain"/>
        <formatter type="xml"/> <!-- for integration builds -->
        <batchtest todir="${testlog.dir}" unless="junit.class">
          <testfileset/>
        </batchtest>
        <test todir="${testlog.dir}" if="junit.class"
          name="${junit.class}" />
      </junit>
      <fail message="Test failure(s)" if="junit.failure"/>
    </sequential>
  </macrodef>

</project>
